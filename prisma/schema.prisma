datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [citext]
}

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

enum StoreType {
  Nisit
  Club
}

enum GoodsType {
  Food
  NonFood
}

enum StoreState {
  // ขั้นตอนการสร้างร้าน
  CreateStore
  ClubInfo
  StoreDetails
  ProductDetails
  Submitted

  // หลังจากส่งแล้ว เข้าสู่สถานะหลัก
  Pending // รอจับฉลาก
  Success // ได้รับเลือก
  Rejected // ไม่ได้รับเลือก (ถ้ามี)
}

/**
 * (ถ้าต้องการ tag บทบาทในร้านแบบง่าย ๆ ให้ใช้ enum นี้; ถ้าไม่ใช้ก็ลบได้)
 */
enum StoreRole {
  Leader
  Staff
}

enum StoreMemberStatus {
  NotFound
  Invited
  Joined
  Declined
}

model UserIdentity {
  providerSub   String
  provider      String
  providerEmail String  @db.Citext
  emailVerified Boolean @default(false)

  // ---- Relation to Nisit (many-to-one)
  nisitId String?
  info    Nisit?  @relation("NisitUserIdentities", fields: [nisitId], references: [nisitId], onDelete: SetNull)

  @@unique([provider, providerSub])
  @@index([providerEmail])
  @@map("user_identity")
}

model Nisit {
  nisitId           String  @id
  firstName         String
  lastName          String
  phone             String  @unique
  email             String  @unique @db.Citext
  nisitCardMediaId  String? @unique
  nisitCardMedia    Media?   @relation("NisitCardMedia", fields: [nisitCardMediaId], references: [id])
  
  /**
   * ---- One Nisit -> One Store (ผ่าน FK เดียว)
   */
  storeId Int?
  store   Store? @relation(fields: [storeId], references: [id], onDelete: SetNull)
  // storeRole      StoreRole?

  // ---- อื่น ๆ ที่มีอยู่เดิม
  userIdentities      UserIdentity[]            @relation("NisitUserIdentities")
  // leadedClubs         ClubInfo[]                @relation("club_leader")
  storeMemberAttempts StoreMemberAttemptEmail[]

  @@index([storeId])
  @@map("nisit")
}

model Store {
  id          Int        @id @default(autoincrement())
  storeName   String
  boothNumber String?    @unique
  type        StoreType
  state       StoreState @default(CreateStore)

  clubInfo    ClubInfo?

  boothMediaId  String?   @unique
  boothMedia    Media?    @relation("BoothMedia", fields: [boothMediaId], references: [id])

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  members Nisit[]
  goods   Goods[]

  memberAttemptEmails StoreMemberAttemptEmail[] @relation("Store_AttemptEmails")

  @@index([type])
  @@index([state])
  @@map("store")
}

model ClubInfo {
  id                  String     @id @default(cuid())
  clubName            String?
  clubApplicationMediaId  String?     @unique
  clubApplicationMedia    Media?     @relation("ClubApplicationMedia", fields: [clubApplicationMediaId], references: [id])

  // หนึ่ง ClubInfo ผูกกับ Store เดียว บังคับต้องมี
  storeId         Int        @unique
  store           Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // --- Leader contact เป็นข้อมูลหลัก (ไม่ต้องเป็น user ในระบบก็ได้)
  leaderFirstName String?
  leaderLastName  String?
  leaderEmail     String?
  leaderPhone     String?
  
  leaderNisitId   String?
  // leader          Nisit?     @relation("club_leader", fields: [leaderNisitId], references: [nisitId], onDelete: SetNull)

  @@map("club_info")
}

model StoreMemberAttemptEmail {
  id      Int   @id @default(autoincrement())
  storeId Int
  store   Store @relation("Store_AttemptEmails", fields: [storeId], references: [id], onDelete: Cascade)

  email   String  @db.Citext
  nisitId String?
  nisit   Nisit?  @relation(fields: [nisitId], references: [nisitId], onDelete: SetNull)

  status StoreMemberStatus @default(Invited) // Invited, Joined, Declined ฯลฯ

  invitedAt DateTime  @default(now())
  joinedAt  DateTime?

  @@unique([storeId, email]) // กันซ้ำภายในร้านเดียวกัน
  @@index([email]) // ใช้ค้นหาเวลาคนสมัครเข้ามา
  // @@index([storeId])
  // @@index([nisitId])
  @@map("store_member_attempt_email")
}

model Goods {
  id        String       @id @default(cuid())
  name      String
  type      GoodsType
  price     Decimal   @db.Decimal(10, 2)
  storeId   Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  goodMediaId String? @unique
  googleMedia Media? @relation("GoodMedia", fields: [goodMediaId], references: [id])

  @@index([storeId])
  @@map("goods")
}

model Media {
  id        String   @id @default(cuid()) // ใช้ id นี้เป็น mediaId ส่งให้ frontend
  provider  String
  externalId String
  mimeType  String
  link       String
  createdBy String?
  createdAt DateTime @default(now())

  nisitCardOwner  Nisit?   @relation("NisitCardMedia")
  clubApplication ClubInfo? @relation("ClubApplicationMedia")
  storeBooth      Store?   @relation("BoothMedia")
  good            Goods?   @relation("GoodMedia")
  @@map("medias")
}