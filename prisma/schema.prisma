datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [citext]
}

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

enum StoreType {
  Nisit
  Club
}

enum GoodsType {
  Food
  NonFood
}

enum StoreStatus {
  Draft
  StoreDetails
  ProductDetails
  Submitted
}

/** (ถ้าต้องการ tag บทบาทในร้านแบบง่าย ๆ ให้ใช้ enum นี้; ถ้าไม่ใช้ก็ลบได้) */
enum StoreRole {
  Leader
  Staff
}

model UserIdentity {
  providerSub    String
  provider       String
  providerEmail  String   @db.Citext
  emailVerified  Boolean  @default(false)

  // ---- Relation to Nisit (many-to-one)
  nisitId        String?
  info           Nisit?   @relation("NisitUserIdentities", fields: [nisitId], references: [nisitId], onDelete: SetNull)

  @@unique([provider, providerSub])
  @@index([providerEmail])
  @@map("user_identity")
}

model Nisit {
  nisitId        String   @id
  firstName      String
  lastName       String
  phone          String   @unique
  email          String   @db.Citext @unique
  nisitCardLink  String?

  /* ---- One Nisit -> One Store (ผ่าน FK เดียว) */
  storeId        Int?
  store          Store?   @relation(fields: [storeId], references: [id], onDelete: SetNull)
  storeRole      StoreRole?

  // ---- อื่น ๆ ที่มีอยู่เดิม
  userIdentities UserIdentity[] @relation("NisitUserIdentities")
  leadedClubs    ClubInfo[]     @relation("club_leader")

  @@index([storeId])
  @@map("nisit")
}

model ClubInfo {
  id               Int       @id @default(autoincrement())
  clubName         String
  leaderNisitId    String?
  applicationLink  String?

  leader           Nisit?    @relation("club_leader", fields: [leaderNisitId], references: [nisitId], onDelete: SetNull)
  stores           Store[]

  @@map("club_info")
}

model Store {
  id           Int         @id @default(autoincrement())
  storeName    String
  boothNumber  String?     @unique
  type         StoreType
  clubInfoId   Int?
  status       StoreStatus
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  clubInfo     ClubInfo?   @relation(fields: [clubInfoId], references: [id], onDelete: SetNull)

  /* ---- One Store -> Many Nisit (ฝั่งกลับจาก FK) */
  members      Nisit[]

  goods        Goods[]

  @@index([type])
  @@index([status])
  @@map("store")
}

model Goods {
  id         Int       @id @default(autoincrement())
  name       String
  type       GoodsType
  price      Decimal   @db.Decimal(10, 2)
  storeId    Int
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  store      Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@map("goods")
}
