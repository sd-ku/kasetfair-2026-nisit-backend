datasource db {
  provider   = "postgresql"
  extensions = [citext]
}

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

enum StoreType {
  Nisit
  Club
}

enum GoodsType {
  Food
  NonFood
}

enum StoreState {
  // ขั้นตอนการสร้างร้าน
  CreateStore
  ClubInfo
  StoreDetails
  ProductDetails
  Submitted

  // หลังจากส่งแล้ว เข้าสู่สถานะหลัก
  Pending // รอตรวจสอบ
  Validated // ได้รับการตรวจสอบแล้ว รอจับฉลาก
  Success // ได้รับเลือก
  Rejected // ไม่ได้รับเลือก (ถ้ามี)
}

/**
 * (ถ้าต้องการ tag บทบาทในร้านแบบง่าย ๆ ให้ใช้ enum นี้; ถ้าไม่ใช้ก็ลบได้)
 */
enum StoreRole {
  Leader
  Staff
}

enum StoreMemberStatus {
  NotFound
  Invited
  Joined
  Declined
}

enum MediaPurpose {
  NISIT_CARD
  STORE_LAYOUT
  STORE_GOODS
  CLUB_APPLICATION
  OTHER
}

enum MediaStatus {
  UPLOADING
  UPLOADED
  FAILED
  DELETE
}

enum StoreQuestionType {
  TEXT
  SINGLE_SELECT
  MULTI_SELECT
}

model ConsentText {
  id           String       @id @default(uuid())
  version      Int
  title        String
  content      String
  language     String      // เช่น th, en
  active       Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  userConsents UserConsent[]

  @@index([language, active])
  @@map("consent_text")
}

model DormitoryType {
  id        Int      @id @default(autoincrement())
  label     String   @unique      // เช่น "ภายใน มก.", "ซอยพหลโยธิน 45 มก."
  isActive  Boolean  @default(true)
  order     Int?                   // เผื่ออยากจัดลำดับการแสดงผลหน้า UI
  
  // ใครใช้อ้างอิงบ้าง
  residents Nisit[]
  
  @@map("dormitory_type")
}

model UserConsent {
  id              String      @id @default(uuid())
  nisitId         String
  consentTextId   String
  accepted        Boolean
  acceptedAt      DateTime    @default(now())
  ipAddress       String?
  userAgent       String?
  deviceInfo      String?

  consentText     ConsentText @relation(fields: [consentTextId], references: [id])

  @@index([nisitId])
  @@index([consentTextId])
  @@map("user_consent")
}

model UserIdentity {
  providerSub   String
  provider      String
  providerEmail String  @db.Citext
  emailVerified Boolean @default(false)

  // ---- Relation to Nisit (many-to-one)
  nisitId String?
  info    Nisit?  @relation("NisitUserIdentities", fields: [nisitId], references: [nisitId], onDelete: SetNull)

  @@unique([provider, providerSub])
  @@index([providerEmail])
  @@map("user_identity")
}

model Nisit {
  id                String  @default(uuid())
  nisitId           String  @id
  firstName         String
  lastName          String
  phone             String?  @unique
  email             String  @unique @db.Citext
  nisitCardMediaId  String? @unique
  nisitCardMedia    Media?   @relation("NisitCardMedia", fields: [nisitCardMediaId], references: [id])

  dormitoryTypeId   Int?
  dormitoryType     DormitoryType? @relation(fields: [dormitoryTypeId], references: [id], onDelete: SetNull)

  // เป็น admin ของร้าน (หนึ่งคนต่อหนึ่งร้าน)
  storeAdminOf      Store?  @relation("StoreAdmin")

  // เป็นสมาชิกในร้าน (One Nisit -> One Store)
  storeId Int?
  store   Store? @relation("StoreMembers", fields: [storeId], references: [id], onDelete: SetNull)

  userIdentities      UserIdentity[]            @relation("NisitUserIdentities")
  storeMemberAttempts StoreMemberAttemptEmail[]

  @@index([storeId])
  @@map("nisit")
}

model Store {
  id          Int        @id @default(autoincrement())
  storeName   String
  boothNumber String?    @unique
  type        StoreType
  state       StoreState @default(CreateStore)

  goodType    GoodsType?

  storeAdminNisitId String @unique
  storeAdmin        Nisit  @relation("StoreAdmin", fields: [storeAdminNisitId], references: [nisitId], onDelete: Cascade)

  clubInfo    ClubInfo?

  boothMediaId  String?   @unique
  boothMedia    Media?    @relation("BoothMedia", fields: [boothMediaId], references: [id])

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  members Nisit[] @relation("StoreMembers")
  goods   Goods[]

  memberAttemptEmails StoreMemberAttemptEmail[] @relation("Store_AttemptEmails")
  questionAnswers     StoreQuestionAnswer[]

  @@index([type])
  @@index([state])
  @@map("store")
}

model ClubInfo {
  id                  String     @id @default(uuid())
  clubName            String?
  clubApplicationMediaId  String?     @unique
  clubApplicationMedia    Media?     @relation("ClubApplicationMedia", fields: [clubApplicationMediaId], references: [id], onDelete: SetNull)

  // หนึ่ง ClubInfo ผูกกับ Store เดียว บังคับต้องมี
  storeId         Int        @unique
  store           Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // --- Leader contact เป็นข้อมูลหลัก (ไม่ต้องเป็น user ในระบบก็ได้)
  leaderFirstName String?
  leaderLastName  String?
  leaderEmail     String?
  leaderPhone     String?
  
  leaderNisitId   String?
  // leader          Nisit?     @relation("club_leader", fields: [leaderNisitId], references: [nisitId], onDelete: SetNull)

  @@map("club_info")
}

model StoreMemberAttemptEmail {
  id      Int   @id @default(autoincrement())
  storeId Int
  store   Store @relation("Store_AttemptEmails", fields: [storeId], references: [id], onDelete: Cascade)

  email   String  @db.Citext
  nisitId String?
  nisit   Nisit?  @relation(fields: [nisitId], references: [nisitId], onDelete: SetNull)

  status StoreMemberStatus @default(Invited) // Invited, Joined, Declined ฯลฯ

  invitedAt DateTime  @default(now())
  joinedAt  DateTime?

  @@unique([storeId, email]) // กันซ้ำภายในร้านเดียวกัน
  @@index([email]) // ใช้ค้นหาเวลาคนสมัครเข้ามา
  // @@index([storeId])
  // @@index([nisitId])
  @@map("store_member_attempt_email")
}

model Goods {
  id        String       @id @default(uuid())
  name      String
  type      GoodsType
  price     Decimal   @db.Decimal(10, 2)
  storeId   Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  goodMediaId String? @unique
  googleMedia Media? @relation("GoodMedia", fields: [goodMediaId], references: [id])

  @@index([storeId])
  @@map("goods")
}

model Media {
  id            String   @id @default(uuid()) // ใช้ id นี้เป็น mediaId ส่งให้ frontend
  provider      String
  bucket        String?
  key           String?  // {bucket}/{key} คือ path เต็มใน S3
  externalId    String?
  
  originalName  String?
  mimeType      String
  size          Int?
  purpose       MediaPurpose  @default(OTHER)
  
  link          String?
  status        MediaStatus   @default(UPLOADING)
  
  createdBy     String?
  createdAt     DateTime @default(now())

  nisitCardOwner  Nisit?   @relation("NisitCardMedia")
  clubApplication ClubInfo? @relation("ClubApplicationMedia")
  storeBooth      Store?   @relation("BoothMedia")
  good            Goods?   @relation("GoodMedia")
  @@map("medias")
}

model StoreQuestionTemplate {
  id          Int                 @id @default(autoincrement())
  key         String              @unique
  label       String
  description String?
  type        StoreQuestionType
  options     Json?
  isActive    Boolean             @default(true)
  order       Int?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  answers     StoreQuestionAnswer[]
  @@map("store_question_template")
}

model StoreQuestionAnswer {
  id          Int                   @id @default(autoincrement())
  storeId     Int
  questionId  Int
  value       Json

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  store       Store                 @relation(fields: [storeId], references: [id])
  question    StoreQuestionTemplate @relation(fields: [questionId], references: [id])

  @@unique([storeId, questionId])
  @@map("store_question_answer")
}
