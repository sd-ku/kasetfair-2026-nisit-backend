// --------------------- DATASOURCE & GENERATOR ---------------------

datasource db {
  provider   = "postgresql"
  extensions = [citext]
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

// --------------------- ENUMS ---------------------

enum StoreType {
  Nisit
  Club
}

enum GoodsType {
  Food
  NonFood
}

enum StoreState {
  CreateStore
  ClubInfo
  StoreDetails
  ProductDetails
  Submitted

  Pending
  Validated
  Success
  Rejected

  deleted
}

enum StoreRole {
  Leader
  Staff
}

enum StoreMemberStatus {
  NotFound
  ProfileNotCompleted
  DuplicateStore
  Invited
  Joined
  Declined
}

enum MediaPurpose {
  NISIT_CARD
  STORE_LAYOUT
  STORE_GOODS
  CLUB_APPLICATION
  OTHER
}

enum MediaStatus {
  UPLOADING
  UPLOADED
  FAILED
  DELETE
}

enum StoreQuestionType {
  TEXT
  SINGLE_SELECT
  MULTI_SELECT
}

// --------------------- MODELS ---------------------

model NisitTrainingParticipant {
  id        String     @id @default(uuid())
  nisitId   String     @unique

  @@index([nisitId])
  @@map("nisit_training_participant")
}

model ConsentText {
  id        String     @id @default(uuid())
  version   Int
  title     String
  content   String
  language  String
  active    Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  userConsents UserConsent[]

  @@index([language, active])
  @@map("consent_text")
}

model DormitoryType {
  id        Int     @id @default(autoincrement())
  label     String  @unique
  isActive  Boolean @default(true)
  order     Int?

  residents Nisit[]

  @@map("dormitory_type")
}

model UserConsent {
  id            String     @id @default(uuid())
  nisitId       String
  consentTextId String
  accepted      Boolean
  acceptedAt    DateTime   @default(now())
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?

  consentText   ConsentText @relation(fields: [consentTextId], references: [id])

  @@index([nisitId])
  @@index([consentTextId])
  @@map("user_consent")
}

model UserIdentity {
  providerSub   String
  provider      String
  providerEmail String @db.Citext
  emailVerified Boolean @default(false)

  nisitId String?
  info    Nisit? @relation("NisitUserIdentities", fields: [nisitId], references: [nisitId], onDelete: SetNull)

  @@unique([provider, providerSub])
  @@index([providerEmail])
  @@map("user_identity")
}

model Nisit {
  id               String @default(uuid())
  nisitId          String @id
  firstName        String
  lastName         String
  phone            String? @unique
  email            String  @unique @db.Citext

  nisitCardMediaId String?    @unique
  nisitCardMedia   Media?     @relation("NisitCardMedia", fields: [nisitCardMediaId], references: [id])

  dormitoryTypeId Int?
  dormitoryType   DormitoryType? @relation(fields: [dormitoryTypeId], references: [id], onDelete: SetNull)

  storeAdminOf Store? @relation("StoreAdmin")

  storeId Int?
  store   Store? @relation("StoreMembers", fields: [storeId], references: [id], onDelete: SetNull)

  userIdentities      UserIdentity[] @relation("NisitUserIdentities")
  storeMemberAttempts StoreMemberAttemptEmail[]

  @@index([storeId])
  @@map("nisit")
}

model Store {
  id          Int        @id @default(autoincrement())
  storeName   String
  boothNumber String?    @unique
  type        StoreType
  state       StoreState @default(CreateStore)

  goodType GoodsType?

  storeAdminNisitId String? @unique
  storeAdmin        Nisit?  @relation("StoreAdmin", fields: [storeAdminNisitId], references: [nisitId], onDelete: Cascade)

  clubInfo    ClubInfo?

  boothMediaId String?   @unique
  boothMedia   Media?    @relation("BoothMedia", fields: [boothMediaId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members Nisit[] @relation("StoreMembers")
  goods   Goods[]

  memberAttemptEmails StoreMemberAttemptEmail[] @relation("Store_AttemptEmails")
  questionAnswers     StoreQuestionAnswer[]
  reviewDrafts        StoreReviewDraft[]

  @@index([storeName, state])
  @@index([type])
  @@index([state])
  @@map("store")
}

model ClubInfo {
  id                    String @id @default(uuid())
  clubName              String?
  clubApplicationMediaId String? @unique
  clubApplicationMedia   Media?  @relation("ClubApplicationMedia", fields: [clubApplicationMediaId], references: [id], onDelete: SetNull)

  storeId Int @unique
  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  leaderFirstName String?
  leaderLastName  String?
  leaderEmail     String?
  leaderPhone     String?

  leaderNisitId String?

  @@map("club_info")
}

model StoreMemberAttemptEmail {
  id      Int   @id @default(autoincrement())
  storeId Int
  store   Store @relation("Store_AttemptEmails", fields: [storeId], references: [id], onDelete: Cascade)

  email   String @db.Citext
  nisitId String?
  nisit   Nisit? @relation(fields: [nisitId], references: [nisitId], onDelete: SetNull)

  status     StoreMemberStatus @default(Invited)
  invitedAt  DateTime @default(now())
  joinedAt   DateTime?

  @@unique([storeId, email])
  @@index([email])
  @@map("store_member_attempt_email")
}

model Goods {
  id        String   @id @default(uuid())
  name      String
  type      GoodsType
  price     Decimal  @db.Decimal(10, 2)
  storeId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  goodMediaId String? @unique
  googleMedia Media? @relation("GoodMedia", fields: [goodMediaId], references: [id])

  @@index([storeId])
  @@map("goods")
}

model Media {
  id           String @id @default(uuid())
  provider     String
  bucket       String?
  key          String?
  externalId   String?

  originalName String?
  mimeType     String
  size         Int?
  purpose      MediaPurpose @default(OTHER)

  link     String?
  status   MediaStatus @default(UPLOADING)
  createdBy String?
  createdAt DateTime @default(now())

  nisitCardOwner  Nisit?   @relation("NisitCardMedia")
  clubApplication ClubInfo? @relation("ClubApplicationMedia")
  storeBooth      Store?    @relation("BoothMedia")
  good            Goods?    @relation("GoodMedia")

  @@map("medias")
}

model StoreQuestionTemplate {
  id          Int    @id @default(autoincrement())
  key         String @unique
  label       String
  description String?
  type        StoreQuestionType
  options     Json?
  isActive    Boolean @default(true)
  order       Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answers StoreQuestionAnswer[]

  @@map("store_question_template")
}

model StoreQuestionAnswer {
  id         Int                   @id @default(autoincrement())
  storeId    Int
  questionId Int
  value      Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store    Store                 @relation(fields: [storeId], references: [id])
  question StoreQuestionTemplate @relation(fields: [questionId], references: [id])

  @@unique([storeId, questionId])
  @@map("store_question_answer")
}

// --------------------- ADMIN ---------------------

enum ReviewStatus {
  NeedFix   // อะไรต้องแก้
  Pending // รอจับฉลาก
  Rejected
  deleted
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
}

model StoreReviewDraft {
  id          String      @id @default(uuid())

  storeId     Int
  store       Store       @relation(fields: [storeId], references: [id])

  adminId     String
  admin       SystemAdmin @relation(fields: [adminId], references: [id])

  status      ReviewStatus
  comment     String?     // ข้อความของ admin
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("store_review_draft")
}

model SystemAdmin {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String
  role      AdminRole
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  reviewDrafts StoreReviewDraft[]

  @@map("system_admin")
}

model RegistrationSettings {
  id                Int      @id @default(autoincrement())
  isManuallyLocked  Boolean  @default(false)  // Admin สามารถ lock/unlock manual ได้
  registrationStart DateTime?                 // เวลาเริ่มลงทะเบียน (optional)
  registrationEnd   DateTime?                 // เวลาสิ้นสุดลงทะเบียน (optional)
  lockMessage       String   @default("ขณะนี้หมดเวลาลงทะเบียนแล้ว กรุณาติดต่อเจ้าหน้าที่หากมีข้อสงสัย")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("registration_settings")
}
